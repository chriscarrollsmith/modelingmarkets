---
title: "Forecasting 10-year US treasury bond yields from PCE inflation rate"
author: "Christopher C. Smith"
date: '2022-06-18'
output: pdf_document
---

```{r setup, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
#Script to predict 10-year yields from PCE inflation rate, factoring in how 
#10-year yields have fallen over time

library(tidyverse)
library(xlsx)
library(lubridate)
library(RSelenium)

#Start Selenium driver and navigate to FRED series for 10-year yields
rD <- rsDriver(browser = "firefox")
driver <- rD[["client"]]
driver$navigate("https://fred.stlouisfed.org/series/DGS10")
Sys.sleep(2)


#Find "Max" button on the page and click it
element <- driver$findElement(using = "xpath",'//*[@id="zoom-all"]')
element$clickElement()
Sys.sleep(1)

#Find "Download" button on the page and click it
element <- driver$findElement(using = "css",'.fg-download-btn-chart-gtm > span:nth-child(1)')
element$clickElement()
Sys.sleep(1)

#Find "CSV" button on the page and get the link from it
element <- driver$findElement(using = "xpath",'//*[@id="download-data-csv"]')
url <- unlist(element$getElementAttribute('href'))

#Get and clean 10-year yield data
download.file(url,"DGS10.csv")
tenyr_df <- read.csv("DGS10.csv") %>%
  mutate(yield = as.numeric(DGS10)) %>%
  filter(!is.na(yield))
tenyr_df <- tenyr_df %>% 
  mutate(year = year(DATE),month = month(DATE)) %>%
  group_by(year,month) %>%
  summarize(mean_yield = mean(yield))
unlink("DGS10.csv")

#Navigate to FRED series for PCE inflation rate
driver$navigate("https://fred.stlouisfed.org/series/PCETRIM12M159SFRBDAL")
Sys.sleep(2)

#Find "Max" button on the page and click it
element <- driver$findElement(using = "xpath",'//*[@id="zoom-all"]')
element$clickElement()
Sys.sleep(1)

#Find "Download" button on the page and click it
element <- driver$findElement(using = "css",'.fg-download-btn-chart-gtm > span:nth-child(1)')
element$clickElement()
Sys.sleep(1)

#Find "CSV" button on the page and get the link from it
element <- driver$findElement(using = "xpath",'//*[@id="download-data-csv"]')
url <- unlist(element$getElementAttribute('href'))

#Get and clean PCE inflation dataset
download.file(url,"PCETRIM12M159SFRBDAL.csv")
pce_df <- read.csv("PCETRIM12M159SFRBDAL.csv") 
pce_df <- pce_df %>%
  mutate(year = year(DATE),month = month(DATE)) %>%
  mutate(twelve_month_pce = as.numeric(PCETRIM12M159SFRBDAL)) %>%
  filter(!is.na(twelve_month_pce)) %>%
  select(-DATE,-PCETRIM12M159SFRBDAL)
unlink("PCETRIM12M159SFRBDAL.csv")

#Join the two tables
joined_df <- inner_join(tenyr_df,pce_df) %>% 
  ungroup() %>%
  mutate(date = as.Date(paste(as.character(year),as.character(month),"1",sep="/"),format="%Y/%m/%d"),
         sequence = row_number())

#Predict 10-year yield based on this simple log regression model using PCE rate
fit <- joined_df %>% lm(mean_yield ~ log(twelve_month_pce), data = .)
initial_predicted_yield <- predict(fit,newdata=data.frame(twelve_month_pce = last(joined_df$twelve_month_pce)))
```

## Introduction

Versions of this chart have been making the rounds. I've shared it myself. Plot historical 10-year bond yields against historical PCE inflation rates, run a simple log regression, and *voila!* today's 10-year yield should be `r paste(round(initial_predicted_yield,2),"%",sep="")`!

But this is not quite right.

```{r chart_1, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
#Plot PCE rate against 10-year yield, with date shown as color
joined_df %>%
  ggplot(aes(x=twelve_month_pce,y=mean_yield,col=date)) +
  geom_point() +
  geom_smooth(method = "lm",formula = y~log(x)) +
  geom_point(data=data.frame(twelve_month_pce = last(joined_df$twelve_month_pce),mean_yield = last(joined_df$mean_yield),date = last(joined_df$date)),color="red") +
  scale_x_continuous(breaks = seq(0,10,by = .5)) + 
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16.25,by = 1.25)) +
  labs(x="TTM PCE Inflation Rate",y="Monthly Average 10-Year Yield",title="10-Year Yield by PCE Inflation Rate",caption="Copyright Wall Street Petting Zoo 2022")
```

## Controlling for time effects

The problem with this plot is that it fails to control for the decrease of 10-year yields over time. Let's investigate whether the time effect on yields is separate from the inflation rate effect. (Spoiler: it is.)

```{r chart_2, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
#Plot yield vs. date
joined_df %>% 
  mutate(twelve_month_pce_strat = factor(round(twelve_month_pce))) %>%
  ggplot(aes(x=date,y=mean_yield)) +
  geom_point() +
  geom_smooth(method="lm",formula=y~log(x)) +
  labs(x="Date",y="Monthly Average 10-Year Yield",title="10-Year Yield over Time",caption="Copyright Wall Street Petting Zoo 2022")
```

One way to check whether the time effect is separate from the inflation rate effect is to stratify by inflation rate, and then plot yield vs. time for each stratum. Removing strata with fewer than 20 data points, we get four plots that all show a decline in yields over time.

```{r chart_3, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
#Stratify by PCE inflation rate and plot yield vs. date
joined_df %>% 
  mutate(twelve_month_pce_strat = factor(round(twelve_month_pce))) %>%
  group_by(twelve_month_pce_strat) %>%
  mutate(n=n()) %>%
  filter(n>20) %>%
  ggplot(aes(x=date,y=mean_yield)) +
  geom_point() +
  geom_smooth(method="lm",formula=y~log(x)) +
  facet_wrap( ~ twelve_month_pce_strat) +
  labs(x="Date",y="Monthly Average 10-Year Yield",title="10-Year Yield over Time, Stratified by PCE Inflation Rate",caption="Copyright Wall Street Petting Zoo 2022")
```

Another way to check for an independent time effect is to subtract our PCE inflation-rate regression model's "predicted" yields from every y-value in our data set. Then we plot the leftover "residual" y-values against the date. Here, again, we find a decline in yields over time.

```{r chart_4, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
#Subtract PCE inflation model from the data and regress for time effect
joined_df %>% 
  mutate(pce_model = predict(lm(mean_yield ~ log(twelve_month_pce), data = .)),
         mean_yield_residual = mean_yield - pce_model) %>%
  ggplot(aes(x=date,y=mean_yield_residual)) +
  geom_point() +
  geom_smooth(method="lm",formula=y~x) +
  labs(x="Date",y="Residual Monthly Average 10-Year Yield",title="Residual 10-Year Yield over Time after Subtracting PCE Inflation-Rate Log Regression Model",caption="Copyright Wall Street Petting Zoo 2022")

#Do a multiple linear regression accounting for both PCE inflation and date
fit <- joined_df %>% lm(mean_yield ~ log(sequence) + log(twelve_month_pce), data = .)

#Predict the model for rates today
df <- data.frame(twelve_month_pce = c(seq(1,8.5,by=0.5),last(joined_df$twelve_month_pce)),sequence=rep(530,times=17)) %>%
  mutate(predicted_yield = predict(fit,newdata = .)) %>%
  mutate(highlight = twelve_month_pce %in% last(joined_df$twelve_month_pce))
final_predicted_yield <- predict(fit,newdata=data.frame(twelve_month_pce = last(joined_df$twelve_month_pce),sequence = last(joined_df$sequence)))
```

Running a multiple regression on our data gives us a combined model that incorporates both the PCE inflation rate effect and the time effect. With this model, we can predict 10-year yields by PCE inflation rate for the year 2022. This gives us a predicted 10-year yield of `r paste(round(final_predicted_yield,2),"%",sep="")`.

## Conclusion

The full model's predicted terminal 10-year yield at about `r paste(round(final_predicted_yield),"%",sep="")` is still well above today's roughly `r paste(round(last(tenyr_df$mean_yield)),"%",sep="")` yield, but well below the approximately `r paste(round(initial_predicted_yield),"%",sep="")` yield predicted by a log regression on the PCE inflation rate without controlling for the change in yields over time.

```{r cleanup, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
#Close Selenium driver
driver$close()
rD[["server"]]$stop()
rm(driver, rD)
gc()
system("taskkill /im java.exe /f", intern=FALSE, ignore.stdout=FALSE)
```